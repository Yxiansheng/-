# TCP 协议

## 定义

TCP（Transmission Control Protocol）：传输控制协议是一种面向连接的、可靠的、基于字节流的传输层通信协议.

## TCP 报文

![TCP报文](../images/TCP协议报文.png)

- SYN(Synchronize Sequence Numbers): 同步序列号标志位，当其为 1 时即说明该报文为建立连接报文，ACK 标志位为 0 为客户端发送给服务端的建立连接请求报文、而 ACK 为 1 则为建立连接响应报文
- ACK(Acknowledge): 确认序号标志，为 1 时表示确认号有效，为 0 表示报文中不含确认信息，忽略确认号字段
- FIN(Finish): 用来释放连接。当 FIN=1 时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。
- SEQ(Sequenue Number): 同步序列号
- 确认序号：Acknowledgment Number：是期望收到对方下一个报文段的第一个数据字节的序号。若确认序号=N,则表明：到序号 N-1 为止的所有数据都已正确收到

## TCP 连接建立过程(三次握手)

1. 客户端首先发送建立连接请求报文，将 SYN 标志设为 1，ACK 标志位为 0，请求序列号设为一个随机生成的值 X（TCP 规定 SYN=1 时不能携带数据），然后进入 SYN_SEND 状态
2. 服务端收到连接建立请求报文后，如果同意连接，则发出确认报文，同时将 SYN 标志设为 1，ACK 标志位为 1，请求序列号设为一个随机值 Y，确认序列号设为 X + 1，此时服务端转为 ACK-RCVD（同步收到）状态
3. 客户端收到服务端的确认报文后，再次向客户端发出确认报文，同时设置 ACK 为 1，SYN 为 X+1，ACK 为 Y+1，至此 TCP 连接已经建立，此时客户端进入 ESTABLISHED（已建立连接）状态。TCP 规定，ACK 报文段可以携带数据，但是如果不携带数据则不消耗序号。
4. 服务端在收到客户端的确认报文后可以变为 ESTABLISHED（已建立连接）状态，即可以正式进行通信

- 三次握手原因  
  防止第一次建立连接请求在某个网络结点滞留，服务端无法及时返回确认请求，此时客户端会认为请求已经丢失，则重新发送建立连接请求，与服务端进行连接通信，在通信结束后，断到该连接。客户端、服务端都变为 CLOSED 状态，而前面滞留的请求此时如果到达服务端，服务端根据该请求返回响应同时转为连接已建立的状态，而客户端此时收到响应报文后，由于处于 CLOSED 状态，会抛弃该响应报文，服务端则会一直等待客户端的通信，造成资源的浪费。

## TCP 连接断开过程(四次挥手)

1. 主动关闭方发送一个 FIN 并进入 FIN_WAIT1 状态
2. 被动关闭方接收到主动关闭方发送的 FIN 并发送 ACK，此时被动关闭方进入 CLOSE_WAIT 状态；主动关闭方收到被动关闭方的 ACK 后，进入 FIN_WAIT2 状态
3. 被动关闭方发送一个 FIN 并进入 LAST_ACK 状态
4. 主动关闭方收到被动关闭方发送的 FIN 并发送 ACK，此时主动关闭方进入 TIME_WAIT 状态，经过 2MSL(报文最大生存时间) 时间后关闭连接；被动关闭方收到主动关闭方的 ACK 后，关闭连接

- 四次挥手的原因：  
  由于 TCP 是全双工通信，被动关闭方在接受到主动关闭方 FIN 报文后会关闭读的通道，但此时可能因为被动关闭方还有数据需要发给对方，所以进入 CLOSE_WAIT 状态，待全部数据发送完毕之后才发送 FIN 报文给主动关闭方，实现双方所有通道的关闭

- 主动关闭方响应被动方的 FIN 报文后需要进入 TIME_WAIT 状态，等待两个报文最大生存时间的原因在于为了防止该响应报文丢失，造成被动关闭方再次发送 FIN 报文无响应的情况
